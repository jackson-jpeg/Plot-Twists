{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 94, "column": 0}, "map": {"version":3,"sources":["file:///Users/jackson/Plot-Twists/contexts/SocketContext.tsx"],"sourcesContent":["'use client'\n\nimport React, { createContext, useContext, useEffect, useState, useRef } from 'react'\nimport { io, Socket } from 'socket.io-client'\nimport type { ServerToClientEvents, ClientToServerEvents } from '@/lib/types'\n\ntype SocketType = Socket<ServerToClientEvents, ClientToServerEvents>\n\ninterface SocketContextType {\n  socket: SocketType | null\n  isConnected: boolean\n}\n\nconst SocketContext = createContext<SocketContextType>({\n  socket: null,\n  isConnected: false\n})\n\nexport function useSocket() {\n  return useContext(SocketContext)\n}\n\n// Singleton socket instance to prevent multiple connections\nlet globalSocket: SocketType | null = null\n\nexport function SocketProvider({ children }: { children: React.ReactNode }) {\n  const [socket, setSocket] = useState<SocketType | null>(null)\n  const [isConnected, setIsConnected] = useState(false)\n  const initRef = useRef(false)\n\n  useEffect(() => {\n    // Prevent double initialization in strict mode\n    if (initRef.current) return\n    initRef.current = true\n\n    // Reuse existing socket or create new one\n    if (!globalSocket) {\n      // Determine socket URL based on environment\n      let socketUrl: string\n\n      if (typeof window !== 'undefined') {\n        // Client-side: check if we're on localhost\n        const isLocalhost = window.location.hostname === 'localhost' ||\n                           window.location.hostname === '127.0.0.1'\n\n        console.log('ðŸ” URL Construction Debug:')\n        console.log('  - window.location.hostname:', window.location.hostname)\n        console.log('  - window.location.origin:', window.location.origin)\n        console.log('  - isLocalhost:', isLocalhost)\n        console.log('  - NEXT_PUBLIC_WS_URL env var:', process.env.NEXT_PUBLIC_WS_URL)\n        console.log('  - Raw NEXT_PUBLIC_WS_URL:', JSON.stringify(process.env.NEXT_PUBLIC_WS_URL))\n\n        if (isLocalhost) {\n          // Local development\n          socketUrl = 'http://localhost:3000'\n          console.log('  âœ… Using localhost URL:', socketUrl)\n        } else if (process.env.NEXT_PUBLIC_WS_URL) {\n          // Production: Use Railway backend\n          // Add https:// if not present\n          const wsUrl = process.env.NEXT_PUBLIC_WS_URL\n          console.log('  - Raw wsUrl before processing:', wsUrl)\n          socketUrl = wsUrl.startsWith('http') ? wsUrl : `https://${wsUrl}`\n          console.log('  âœ… Using Railway backend URL:', socketUrl)\n        } else {\n          // Fallback to same origin\n          socketUrl = window.location.origin\n          console.log('  âš ï¸ Using fallback (same origin) URL:', socketUrl)\n        }\n      } else {\n        // Server-side fallback\n        const wsUrl = process.env.NEXT_PUBLIC_WS_URL || 'http://localhost:3000'\n        socketUrl = wsUrl.startsWith('http') ? wsUrl : `https://${wsUrl}`\n        console.log('  ðŸ–¥ï¸ Server-side URL construction:', socketUrl)\n      }\n\n      console.log('ðŸ”Œ Final Socket Connection Config:')\n      console.log('  - Final Target URL:', socketUrl)\n      console.log('  - Environment:', process.env.NODE_ENV)\n      console.log('  - Protocol:', socketUrl.split('://')[0])\n      console.log('  - Host:', socketUrl.split('://')[1])\n\n      // Configure transports based on environment\n      // Railway can be flaky with WebSocket upgrades, so we force polling in production\n      const isProduction = !socketUrl.includes('localhost')\n\n      globalSocket = io(socketUrl, {\n        path: '/socket.io',\n        reconnection: true,\n        reconnectionDelay: 1000,\n        reconnectionDelayMax: 5000,\n        reconnectionAttempts: 10,\n        // Force polling-only in production (Railway), allow upgrade in dev\n        transports: isProduction ? ['polling'] : ['polling', 'websocket'],\n        upgrade: !isProduction, // Disable WebSocket upgrade in production\n        timeout: 20000,\n        autoConnect: true,\n        withCredentials: true,\n        forceNew: false,\n        multiplex: true\n      })\n\n      console.log('  - Transport mode:', isProduction ? 'polling-only (production)' : 'polling + websocket (dev)')\n\n      globalSocket.on('connect', () => {\n        console.log('Socket connected:', globalSocket?.id)\n        setIsConnected(true)\n      })\n\n      globalSocket.on('disconnect', (reason) => {\n        console.log('Socket disconnected:', reason)\n        setIsConnected(false)\n      })\n\n      globalSocket.on('connect_error', (error) => {\n        console.error('Socket connection error:', error)\n      })\n    }\n\n    setSocket(globalSocket)\n\n    // Don't disconnect on unmount to prevent issues with strict mode\n    return () => {\n      // Only disconnect if window is actually closing\n      if (typeof window !== 'undefined') {\n        window.addEventListener('beforeunload', () => {\n          globalSocket?.disconnect()\n        })\n      }\n    }\n  }, [])\n\n  return (\n    <SocketContext.Provider value={{ socket, isConnected }}>\n      {children}\n    </SocketContext.Provider>\n  )\n}\n"],"names":[],"mappings":";;;;;;;AAEA;AACA;AAHA;;;;AAaA,MAAM,8BAAgB,IAAA,sNAAa,EAAoB;IACrD,QAAQ;IACR,aAAa;AACf;AAEO,SAAS;IACd,OAAO,IAAA,mNAAU,EAAC;AACpB;AAEA,4DAA4D;AAC5D,IAAI,eAAkC;AAE/B,SAAS,eAAe,EAAE,QAAQ,EAAiC;IACxE,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,iNAAQ,EAAoB;IACxD,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,iNAAQ,EAAC;IAC/C,MAAM,UAAU,IAAA,+MAAM,EAAC;IAEvB,IAAA,kNAAS,EAAC;QACR,+CAA+C;QAC/C,IAAI,QAAQ,OAAO,EAAE;QACrB,QAAQ,OAAO,GAAG;QAElB,0CAA0C;QAC1C,IAAI,CAAC,cAAc;YACjB,4CAA4C;YAC5C,IAAI;YAEJ;;iBA4BO;gBACL,uBAAuB;gBACvB,MAAM,QAAQ,2DAAkC;gBAChD,YAAY,MAAM,UAAU,CAAC,UAAU,QAAQ,CAAC,QAAQ,EAAE,OAAO;gBACjE,QAAQ,GAAG,CAAC,uCAAuC;YACrD;YAEA,QAAQ,GAAG,CAAC;YACZ,QAAQ,GAAG,CAAC,yBAAyB;YACrC,QAAQ,GAAG,CAAC;YACZ,QAAQ,GAAG,CAAC,iBAAiB,UAAU,KAAK,CAAC,MAAM,CAAC,EAAE;YACtD,QAAQ,GAAG,CAAC,aAAa,UAAU,KAAK,CAAC,MAAM,CAAC,EAAE;YAElD,4CAA4C;YAC5C,kFAAkF;YAClF,MAAM,eAAe,CAAC,UAAU,QAAQ,CAAC;YAEzC,eAAe,IAAA,8LAAE,EAAC,WAAW;gBAC3B,MAAM;gBACN,cAAc;gBACd,mBAAmB;gBACnB,sBAAsB;gBACtB,sBAAsB;gBACtB,mEAAmE;gBACnE,YAAY,eAAe;oBAAC;iBAAU,GAAG;oBAAC;oBAAW;iBAAY;gBACjE,SAAS,CAAC;gBACV,SAAS;gBACT,aAAa;gBACb,iBAAiB;gBACjB,UAAU;gBACV,WAAW;YACb;YAEA,QAAQ,GAAG,CAAC,uBAAuB,eAAe,8BAA8B;YAEhF,aAAa,EAAE,CAAC,WAAW;gBACzB,QAAQ,GAAG,CAAC,qBAAqB,cAAc;gBAC/C,eAAe;YACjB;YAEA,aAAa,EAAE,CAAC,cAAc,CAAC;gBAC7B,QAAQ,GAAG,CAAC,wBAAwB;gBACpC,eAAe;YACjB;YAEA,aAAa,EAAE,CAAC,iBAAiB,CAAC;gBAChC,QAAQ,KAAK,CAAC,4BAA4B;YAC5C;QACF;QAEA,UAAU;QAEV,iEAAiE;QACjE,OAAO;YACL,gDAAgD;YAChD;;QAKF;IACF,GAAG,EAAE;IAEL,qBACE,8OAAC,cAAc,QAAQ;QAAC,OAAO;YAAE;YAAQ;QAAY;kBAClD;;;;;;AAGP"}}]
}