{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/jackson/Plot-Twists/contexts/SocketContext.tsx"],"sourcesContent":["'use client'\n\nimport React, { createContext, useContext, useEffect, useState, useRef } from 'react'\nimport { io, Socket } from 'socket.io-client'\nimport type { ServerToClientEvents, ClientToServerEvents } from '@/lib/types'\n\ntype SocketType = Socket<ServerToClientEvents, ClientToServerEvents>\n\ninterface SocketContextType {\n  socket: SocketType | null\n  isConnected: boolean\n}\n\nconst SocketContext = createContext<SocketContextType>({\n  socket: null,\n  isConnected: false\n})\n\nexport function useSocket() {\n  return useContext(SocketContext)\n}\n\n// Singleton socket instance to prevent multiple connections\nlet globalSocket: SocketType | null = null\n\nexport function SocketProvider({ children }: { children: React.ReactNode }) {\n  const [socket, setSocket] = useState<SocketType | null>(null)\n  const [isConnected, setIsConnected] = useState(false)\n  const initRef = useRef(false)\n\n  useEffect(() => {\n    // Prevent double initialization in strict mode\n    if (initRef.current) return\n    initRef.current = true\n\n    // Reuse existing socket or create new one\n    if (!globalSocket) {\n      // Determine socket URL based on environment\n      let socketUrl: string\n\n      if (typeof window !== 'undefined') {\n        // Client-side: check if we're on localhost\n        const isLocalhost = window.location.hostname === 'localhost' ||\n                           window.location.hostname === '127.0.0.1'\n\n        console.log('ðŸ” URL Construction Debug:')\n        console.log('  - window.location.hostname:', window.location.hostname)\n        console.log('  - window.location.origin:', window.location.origin)\n        console.log('  - isLocalhost:', isLocalhost)\n        console.log('  - NEXT_PUBLIC_WS_URL env var:', process.env.NEXT_PUBLIC_WS_URL)\n        console.log('  - Raw NEXT_PUBLIC_WS_URL:', JSON.stringify(process.env.NEXT_PUBLIC_WS_URL))\n\n        if (isLocalhost) {\n          // Local development\n          socketUrl = 'http://localhost:3000'\n          console.log('  âœ… Using localhost URL:', socketUrl)\n        } else if (process.env.NEXT_PUBLIC_WS_URL) {\n          // Production: Use Railway backend\n          // Add https:// if not present\n          const wsUrl = process.env.NEXT_PUBLIC_WS_URL\n          console.log('  - Raw wsUrl before processing:', wsUrl)\n          socketUrl = wsUrl.startsWith('http') ? wsUrl : `https://${wsUrl}`\n          console.log('  âœ… Using Railway backend URL:', socketUrl)\n        } else {\n          // Fallback to same origin\n          socketUrl = window.location.origin\n          console.log('  âš ï¸ Using fallback (same origin) URL:', socketUrl)\n        }\n      } else {\n        // Server-side fallback\n        const wsUrl = process.env.NEXT_PUBLIC_WS_URL || 'http://localhost:3000'\n        socketUrl = wsUrl.startsWith('http') ? wsUrl : `https://${wsUrl}`\n        console.log('  ðŸ–¥ï¸ Server-side URL construction:', socketUrl)\n      }\n\n      console.log('ðŸ”Œ Final Socket Connection Config:')\n      console.log('  - Final Target URL:', socketUrl)\n      console.log('  - Environment:', process.env.NODE_ENV)\n      console.log('  - Protocol:', socketUrl.split('://')[0])\n      console.log('  - Host:', socketUrl.split('://')[1])\n\n      // Configure transports based on environment\n      // Railway can be flaky with WebSocket upgrades, so we force polling in production\n      const isProduction = !socketUrl.includes('localhost')\n\n      globalSocket = io(socketUrl, {\n        path: '/socket.io',\n        reconnection: true,\n        reconnectionDelay: 1000,\n        reconnectionDelayMax: 5000,\n        reconnectionAttempts: 10,\n        // Force polling-only in production (Railway), allow upgrade in dev\n        transports: isProduction ? ['polling'] : ['polling', 'websocket'],\n        upgrade: !isProduction, // Disable WebSocket upgrade in production\n        timeout: 20000,\n        autoConnect: true,\n        withCredentials: true,\n        forceNew: false,\n        multiplex: true\n      })\n\n      console.log('  - Transport mode:', isProduction ? 'polling-only (production)' : 'polling + websocket (dev)')\n\n      globalSocket.on('connect', () => {\n        console.log('Socket connected:', globalSocket?.id)\n        setIsConnected(true)\n      })\n\n      globalSocket.on('disconnect', (reason) => {\n        console.log('Socket disconnected:', reason)\n        setIsConnected(false)\n      })\n\n      globalSocket.on('connect_error', (error) => {\n        console.error('Socket connection error:', error)\n      })\n    }\n\n    setSocket(globalSocket)\n\n    // Don't disconnect on unmount to prevent issues with strict mode\n    return () => {\n      // Only disconnect if window is actually closing\n      if (typeof window !== 'undefined') {\n        window.addEventListener('beforeunload', () => {\n          globalSocket?.disconnect()\n        })\n      }\n    }\n  }, [])\n\n  return (\n    <SocketContext.Provider value={{ socket, isConnected }}>\n      {children}\n    </SocketContext.Provider>\n  )\n}\n"],"names":[],"mappings":"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"}}]
}